## C# の「=>」とは（ラムダ演算子と式形式メンバー）

**要点**
- **「=>」はラムダ演算子**。無名関数（ラムダ式）や、短く書けるメンバー定義（式形式メンバー）で使う。
- **読み**: 「ファットアロー」。
- **主な用途**: ラムダ式、式形式メソッド/プロパティ、`switch` 式、LINQ、イベント購読など。
- **注意**: キャプチャによる割り当て（GC）・パフォーマンス、`Func` と `Expression<Func<...>>` の違い。

---

### 1) ラムダ式（無名関数）
ラムダ式はその場で関数を作る構文。`(引数) => 本体` の形で書く。

```csharp
// 単一式ラムダ（式の値がそのまま戻り値）
Func<int, int> doubleIt = x => x * 2;

// 複数文ラムダ（ブロックで記述）
Func<int, int> factorial = n => {
    var result = 1;
    for (var i = 2; i <= n; i++) result *= i;
    return result;
};
```

Unity でのよくある利用例:

```csharp
// LINQ
var aliveEnemies = enemies.Where(e => e.IsAlive);

// イベント購読（Input System など）
action.performed += ctx => Debug.Log(ctx.ReadValue<float>());
```

ポイント:
- **型推論**されるため、引数型は省略可能（曖昧でなければ）。
- **キャプチャ**（外側の変数や `this` を参照）すると、クロージャの割り当てが発生する場合がある。
- `async` と併用できる（`async x => await ...`）。

---

### 2) 式形式メンバー（expression-bodied members）
短いメソッドやプロパティを 1 行で書くための構文。

```csharp
// メソッド
int Area(int w, int h) => w * h;

// 読み取り専用プロパティ
int Width => _width;

// アクセサ（C# 7+）
int Width2 { get => _width2; set => _width2 = value; }

// コンストラクタ / ファイナライザ（C# 7+）
public MyClass(int x) => _x = x;
~MyClass() => Dispose();

// インデクサ（C# 7+）
int this[int i] => _data[i];
```

---

### 3) `switch` 式での `=>`
`switch` 式では、パターンと結果の対応に `=>` を使う。

```csharp
string Describe(int x) => x switch
{
    <= 0 => "non-positive",
    1    => "one",
    _    => "other"
};
```

---

### 4) `Func` と `Expression<Func<...>>` の違い
- `Func<T, TResult>` 等: 実行可能なデリゲート。普通のコードとして実行される。
- `Expression<Func<T, TResult>>`: 式ツリー（構文の木）。LINQ to Entities などで SQL 変換に使われる。
  - 単一式ラムダのみ変換可能（ブロック文ラムダは不可）。

---

### 5) パフォーマンスの注意（Unity）
- **キャプチャに注意**: ラムダが外部変数や `this` を参照すると、クロージャのためにヒープ割り当てが発生することがある。
  - フレームごと（`Update` 等）に新しいラムダを生成しない。
  - 可能なら **メソッドグループ**（`OnEvent` など）を使って割り当てを避ける。
  - C# 9+ では **`static` ラムダ**（`static x => ...`）でキャプチャを禁止し、割り当てを抑制できる。

```csharp
// 悪い例（毎フレーム新しいクロージャを生成する恐れ）
void Update() {
    button.onClick.AddListener(() => DoSomething(value));
}

// 良い例（あらかじめ購読しておく or メソッドグループを使う）
void Awake() {
    button.onClick.AddListener(OnClick);
}
void OnClick() { DoSomething(value); }
```

---

### 6) 代表的な書き方まとめ
```csharp
// ラムダ式
x => x * 2
(x, y) => x + y
(int x) => x * x
async x => await DoAsync(x)
static x => x * 2 // C# 9+

// 式形式メンバー
int Count => _count;
int Add(int a, int b) => a + b;

// switch 式
var label = n switch { < 0 => "neg", 0 => "zero", _ => "pos" };
```

---

### 7) ひとことで言うと
**「=>」は、関数やマッピングを“簡潔に書くための記号”**。主にラムダ式と式形式メンバー、`switch` 式で使い、短く読みやすいコードを書くのに役立つ。ただし、**キャプチャによる割り当て**や **ホットパスでの使いすぎ**には注意。


