# æ•µã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸ï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å¯¾å¿œï¼‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€æ•µAIã‚’ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³æ–¹å¼ã«åˆ·æ–°ã—ãŸè¨­è¨ˆä»•æ§˜ã‚’ç¤ºã—ã¾ã™ã€‚å„æŒ™å‹•ã¯ã€ŒçŠ¶æ…‹ã€å˜ä½ã®ç‹¬ç«‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè£…ã•ã‚Œã€`EnemyAIBrainState` ãŒç¾åœ¨çŠ¶æ…‹ã®ç®¡ç†ãƒ»é·ç§»ãƒ»æ›´æ–°ã‚’æ‹…å½“ã—ã¾ã™ã€‚

## ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ 

```
Enemy/
â”œâ”€â”€ AI/
â”‚   â”œâ”€â”€ EnemyAIBrainState.cs      # ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³æœ¬ä½“
â”‚   â””â”€â”€ States/                   # å…·ä½“ã‚¹ãƒ†ãƒ¼ãƒˆç¾¤ï¼ˆææ¡ˆï¼‰
â”‚       â”œâ”€â”€ EnemyIdleState.cs
â”‚       â”œâ”€â”€ EnemyChaseState.cs
â”‚       â”œâ”€â”€ EnemyAttackState.cs
â”‚       â””â”€â”€ EnemyDeadState.cs
â”œâ”€â”€ Combat/
â”œâ”€â”€ Core/
â”œâ”€â”€ Spawning/
â””â”€â”€ Types/
```

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

1. **BaseEnemy**: ã™ã¹ã¦ã®æ•µã®æŠ½è±¡åŸºåº•ã€‚ç§»å‹•ãƒ»æ”»æ’ƒAPIã¨å…±é€šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æä¾›
2. **EnemyAIBrainState**: ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã€‚`IEnemyState` ã‚’ä¿æŒã—ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¨©é™ä¸‹ã§æ›´æ–°
3. **IEnemyState + å…·ä½“ã‚¹ãƒ†ãƒ¼ãƒˆ**: `Enter/Update/Exit` ã‚’å®Ÿè£…ã™ã‚‹æŒ¯ã‚‹èˆã„å˜ä½ã®ã‚¯ãƒ©ã‚¹
4. **WaveSpawner / EnemyCoordinator**: ã‚¹ãƒãƒ¼ãƒ³ã¨æ’ƒç ´ç®¡ç†ï¼ˆå¾“æ¥é€šã‚Šï¼‰

```mermaid
classDiagram
direction LR

class BaseEnemy {
  <<abstract>>
  +bool IsAlive
  +float _moveSpeed
  +float _attackDamage
  +float _visionRange
  +float _attackRange
  +LayerMask _targetMask
  +void Initialize()*
  +void AttackTarget()*
  +void Death()
}

class EnemyAIBrainState {
  +AIState State
  -IEnemyState _current
  +void Initialize()
  +void TransitionTo(IEnemyState)
  +void FixedUpdateNetwork()
}

class IEnemyState {
  <<interface>>
  +void Enter()
  +void Update()
  +void Exit()
}

class EnemyIdleState
class EnemyChaseState
class EnemyAttackState
class EnemyDeadState

BaseEnemy <|.. EnemyWakame
EnemyAIBrainState ..> IEnemyState : holds
IEnemyState <|.. EnemyIdleState
IEnemyState <|.. EnemyChaseState
IEnemyState <|.. EnemyAttackState
IEnemyState <|.. EnemyDeadState
```

## ğŸ“‹ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»•æ§˜

### BaseEnemyï¼ˆåŸºåº•ã‚¯ãƒ©ã‚¹ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `Core/BaseEnemy.cs`

- Fusionã® `NetworkBehaviour` ã‚’ç¶™æ‰¿
- ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: `_maxHealth`, `_moveSpeed`, `_attackDamage`, `_visionRange`, `_attackRange`, `_targetMask`, `[Networked] IsAlive`
- ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«: `Spawned()` å†…ã§ `IsAlive=true`ã€`EnemyAIBrainState` å–å¾—å¾Œã« `Initialize()` ã‚’å‘¼ã¶
- æŠ½è±¡API: `Initialize()`, `AttackTarget()`

### EnemyAIBrainStateï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³æœ¬ä½“ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `AI/EnemyAIBrainState.cs`

- `[Networked] AIState State { get; }` ã‚’å…¬é–‹ï¼ˆåŒæœŸç”¨ã®çŠ¶æ…‹åˆ—æŒ™ï¼‰
- å†…éƒ¨ã« `IEnemyState _current` ã‚’ä¿æŒã—ã€æ¨©é™å´ã®ã¿ `Update()` ã‚’å‘¼ã¶
- ä»£è¡¨API

```csharp
public interface IEnemyState {
    void Enter();
    void Update();
    void Exit();
}

public sealed class EnemyAIBrainState : NetworkBehaviour {
    public enum AIState { Idle, Chase, Attack, Dead }

    [Networked] public AIState State { get; private set; }

    private IEnemyState _current;
    // å¿…è¦ãªã‚‰å„ã‚¹ãƒ†ãƒ¼ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    public IEnemyState Idle  { get; private set; }
    public IEnemyState Chase { get; private set; }
    public IEnemyState Attack{ get; private set; }
    public IEnemyState Dead  { get; private set; }

    public void Initialize() {
        // ã‚¹ãƒ†ãƒ¼ãƒˆç”Ÿæˆãƒ»åˆæœŸé·ç§»
        State = AIState.Idle;
        TransitionTo(Idle);
    }

    public void TransitionTo(IEnemyState next) {
        if (_current == next) return;
        _current?.Exit();
        _current = next;
        _current?.Enter();
    }

    public override void FixedUpdateNetwork() {
        if (!HasStateAuthority) return;
        _current?.Update();
    }
}
```

### å…·ä½“ã‚¹ãƒ†ãƒ¼ãƒˆï¼ˆä¾‹ï¼‰

- å…±é€šå‰æ
  - ãã‚Œãã‚Œ `EnemyAIBrainState` ã¨ `BaseEnemy` ã¸ã®å‚ç…§ã‚’ä¿æŒ
  - æ›´æ–°ã¯ `EnemyAIBrainState.FixedUpdateNetwork()` ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
  - é·ç§»ã¯ `machine.TransitionTo(...)` ã‚’ä½¿ç”¨

- IdleState
  - ä¸€å®šé–“éš”ã§ç´¢æ•µï¼ˆ`_visionRange`ã€`_targetMask`ï¼‰
  - å°„ç¨‹å†…: AttackState ã¸ï¼è¦–ç•Œå†…: ChaseState ã¸ï¼ãƒ­ã‚¹ãƒˆ: Idleç¶™ç¶š

- ChaseState
  - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸å›é ­ã—ã¦ `_moveSpeed` ã§å‰é€²
  - å°„ç¨‹å†…ãªã‚‰ AttackStateã€è¦–ç•Œå¤–ãªã‚‰ IdleState ã¸

- AttackState
  - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸å›é ­ã— `BaseEnemy.AttackTarget()` ã‚’å‘¼ã¶
  - `TickTimer` ã§æ”»æ’ƒã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç®¡ç†
  - å°„ç¨‹å¤–ã§ ChaseState ã¸

- DeadState
  - å…¥å ´æ™‚ã«ç§»å‹•/æ”»æ’ƒã‚’åœæ­¢ã€‚æ›´æ–°ã¯åŸºæœ¬ãªã—

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆæ›´æ–°ï¼‰

```mermaid
sequenceDiagram
  participant Spawner as WaveSpawner
  participant Enemy as BaseEnemy/Types
  participant Brain as EnemyAIBrainState
  participant State as IEnemyState(å„å…·ä½“ã‚¹ãƒ†ãƒ¼ãƒˆ)

  Spawner->>Enemy: Runner.Spawn(prefab)
  Enemy-->>Brain: GetComponent + Initialize()
  Brain->>State: TransitionTo(Idle)
  loop æ¨©é™å´ã®Tick
    Brain->>State: Update()
    State-->>Brain: TransitionTo(Chase/Attack/Dead) ãªã©
  end
```

## âš¡ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ–¹é‡

- ã‚¹ãƒ†ãƒ¼ãƒˆæ›´æ–°ã¯ `HasStateAuthority == true` ã®ãƒ©ãƒ³ãƒŠãƒ¼ã®ã¿å®Ÿè¡Œ
- è¡¨ç¤ºã«å¿…è¦ãªè»½é‡æƒ…å ±ã¯ `[Networked]` ã§åŒæœŸï¼ˆä¾‹: `AIState State`ï¼‰
- å°„æ’ƒãªã©ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆã¯ `Runner.Spawn()` ã‚’ä½¿ç”¨

## ğŸ§© `EnemyWakame` ã¨ã®é–¢ä¿‚

- `EnemyWakame : BaseEnemy` ã¯æ”»æ’ƒæ‰‹æ®µï¼ˆå¼¾ç”Ÿæˆï¼‰ã‚’æä¾›
- AttackState å†…ã‹ã‚‰ `owner.AttackTarget()` ã‚’å‘¼ã³ã€`BulletMove` ã‚’ `Runner.Spawn` ã™ã‚‹
- ä¾‹ï¼ˆæŠœç²‹ï¼‰

```csharp
// EnemyWakame.AttackTarget()
var dir = (target.position - transform.position).normalized;
var bullet = Runner.Spawn(_bulletPrefab, transform.position + dir * 2, Quaternion.LookRotation(dir));
bullet.Init(dir);
```

## ğŸ›  å®Ÿè£…ã‚¬ã‚¤ãƒ‰

1. `AI/States/` ã‚’ä½œæˆã—ã€`IEnemyState` ã¨å„ã‚¹ãƒ†ãƒ¼ãƒˆã‚’é…ç½®
2. `EnemyAIBrainState.Initialize()` ã§å„ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã€åˆæœŸé·ç§»ã‚’å®Ÿæ–½
3. ã‚¹ãƒ†ãƒ¼ãƒˆå†…ã§ `BaseEnemy` ã®APIï¼ˆç§»å‹•ãƒ»æ”»æ’ƒï¼‰ã‚’å‘¼ã¶
4. é·ç§»æ¡ä»¶ã¯ã€Œè·é›¢ã€ã€Œè¦–ç•Œã€ã€Œç”Ÿå­˜ã€ã®3è»¸ã‚’åŸºæº–ã«çµ±ä¸€

## âœ… å®Œäº†æ¡ä»¶ï¼ˆå—ã‘å…¥ã‚ŒåŸºæº–ï¼‰

- çŠ¶æ…‹ã¯ `Idle/Chase/Attack/Dead` ã®4ç¨®ã‚’æœ€ä½é™æä¾›
- æ¨©é™å´ã®ã¿ã§ `Update()` ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨
- `AIState` ã®å€¤ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã§åŒæœŸã•ã‚ŒUI/ãƒ‡ãƒãƒƒã‚°ã§è¦³æ¸¬å¯èƒ½
- `EnemyWakame` ãŒ AttackState çµŒç”±ã§å°„æ’ƒã§ãã‚‹ã“ã¨

## ğŸ“Œ å‚è€ƒï¼šã‚¯ãƒ©ã‚¹å‘½åãƒãƒªã‚·ãƒ¼ï¼ˆæ•µã‚¿ã‚¤ãƒ—ï¼‰

- æ©Ÿèƒ½ãƒ™ãƒ¼ã‚¹: `EnemyShooter`, `EnemyCharger`, `EnemyBomber`
- è¡Œå‹•+æ­¦å™¨: `EnemyKelpShooter`ï¼ˆç¾`EnemyWakame`ã«è¿‘ã„ï¼‰, `EnemyTurret`
- éšå±¤ã‚’ä¿ã¤å ´åˆã¯ `Types/` é…ä¸‹ã§ `Enemy<Behavior>` ã«çµ±ä¸€

---

ä½œæˆæ—¥: 2024å¹´ï¼æœ€çµ‚æ›´æ–°: ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³æ–¹å¼ã«åˆ·æ–°