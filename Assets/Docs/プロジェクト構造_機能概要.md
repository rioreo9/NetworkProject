# FPS協力防衛ゲーム - プロジェクト構造・機能概要

## プロジェクト概要

**ジャンル**: FPS視点の3Dオンライン協力防衛ゲーム  
**プレイ人数**: 1～4人（マルチプレイヤー対応）  
**プラットフォーム**: Unity + C#  
**技術スタック**: R3、VContainer、UniTask、HDRP、Photon Fusion2（Build 920）、VitalRouter

### ゲームコンセプト
戦艦内を移動しながらウェーブ形式で襲来する敵から防衛する協力防衛ゲーム。最大4人のプレイヤーがネットワーク同期された環境で連携して戦う。

## ディレクトリ構造と機能

### Assets/
プロジェクトのメインディレクトリ

```
Assets/
├── Animation/               # アニメーション素材
│   ├── Character/          # キャラクター用アニメーション
│   └── Object/             # オブジェクト用アニメーション
├── Docs/                   # プロジェクト文書
├── Editor/                 # エディター拡張
├── Material/               # マテリアル素材
├── Prefab/                 # プレハブ
├── Scene/                  # シーン
├── Scripts/                # スクリプト（メインロジック）
├── Settings/               # プロジェクト設定
└── VisualPackage/          # ビジュアル素材
```

### Scripts/ - メインロジック

#### Core/ - コアシステム
システム全体の基盤となる機能群

##### DI/（依存性注入システム）
- **ProjectInstaller.cs**: VContainer + VitalRouter統合
  - DIコンテナ設定
  - システム間の依存関係管理
  - コマンドルーティング設定

##### GameFlow/（ゲームフロー管理）
- **GameFlowHandler.cs**: ゲーム状態管理
  - GameState enumによる状態定義
  - R3によるリアクティブ状態管理
  - VitalRouterコマンドシステム統合
  - ネットワーク同期対応

##### Interfaces/
- **IGameStateNotice.cs**: ゲーム状態通知インターフェース

##### Wave/（ウェーブ管理システム）
- **WaveHandler.cs**: ウェーブ進行管理
  - ゲーム状態に応じたウェーブ開始/終了
  - タイマーベース制御
  - 依存性注入対応
- **EnemyCoordinator.cs**: 敵全体統括
  - 生存敵数の同期管理
  - 全滅検知とウェーブクリア判定
- **WaveConfiguration.cs**: ウェーブ設定
  - ScriptableObjectベースの設定システム

#### Gameplay/ - ゲームプレイ機能

##### Character/（キャラクター関連）

###### Animation/
- **AnimationConductor.cs**: アニメーション制御統括

###### Camera/
- **PlayerAvatarView.cs**: プレイヤー視点カメラ
  - Cinemachine統合
  - カメラ優先度制御
- **PlayerCameraController.cs**: カメラ制御
- **PlayerInteractionController.cs**: インタラクション制御
- **PlayerToolController.cs**: ツール制御

###### Enemy/（敵システム）

**AI/**（敵AI状態管理）
- **EnemyAIBrainState.cs**: AI脳状態制御
  - ステートマシンベース行動制御
  - ネットワーク同期対応
- **States/**：各AI状態実装
  - **EnemyIdleState.cs**: 待機状態
  - **EnemyChaseState.cs**: 追跡状態
  - **EnemyAttackState.cs**: 攻撃状態
  - **EnemyDeadState.cs**: 死亡状態

**Core/**（敵基盤システム）
- **BaseEnemy.cs**: 敵基底クラス
  - 共通プロパティとAPI提供
  - ネットワーク同期対応
  - 抽象メソッド定義

**Spawning/**（敵生成システム）
- **WaveSpawner.cs**: ウェーブ式敵生成
  - NetworkRunner.Spawn統合
  - 設定ベース生成制御

**Types/**（敵タイプ別実装）
- **EnemyShooter.cs**: 射撃型敵
  - 弾丸生成・発射機能
  - 攻撃間隔制御
- **EnemyWakame.cs**: ワカメ型敵
  - ターゲット検索機能
  - 自動照準システム

###### Input/（入力システム）
- **GameInput.cs**: ゲーム入力定義
- **InputManager.cs**: 入力管理
- **PlayerNetworkInput.cs**: ネットワーク入力同期
  - Photon Fusion入力システム統合

###### その他キャラクター機能
- **ISetPlayerInformation.cs**: プレイヤー情報設定インターフェース
- **NetworkedDamageable.cs**: ネットワーク対応ダメージシステム
  - IDamageableインターフェース実装
  - HP同期管理
- **PlayerAvatar.cs**: プレイヤーアバター管理

###### Pys/（物理・移動システム）
- **PlayerJump.cs**: ジャンプ機能
- **PlayerMove.cs**: 基本移動
- **PlayerMovement.cs**: 移動制御統括
- **PlayerPhysicsMove.cs**: 物理ベース移動
- **RotationMove.cs**: 回転制御

##### Combat/（戦闘システム）
- **BulletMove.cs**: 弾丸システム
  - Photon Fusion2ラグ補償機能使用
  - TickTimerベース寿命管理
  - ネットワーク同期対応
  - IDamageableインターフェース対応当たり判定

##### Environment/（環境システム）

**Ship/Shield/**（シールドシステム）
- **ShipShieldSystem.cs**: シールド制御
- **ShipShieldDurability.cs**: 耐久値管理
- **ShipShieldVisualizer.cs**: ビジュアル表現

##### InteractObjectScripts/（インタラクトシステム）

**AttackObject/**
- **LaserGun.cs**: レーザーガン

**Base/**
- **BaseInteractButtonObject.cs**: ボタン系インタラクト基底
- **BaseInteractObject.cs**: インタラクト基底クラス
- **BasePickUpToolObject.cs**: ピックアップツール基底

**Interfaces/**
- インタラクション関連インターフェース群

**Objects/** & **Tools/**
- 各種インタラクト可能オブジェクト・ツール実装

#### Infrastructure/（インフラストラクチャ）
- **ComponentUtility.cs**: コンポーネントユーティリティ
- **GameObjectExtensions.cs**: GameObject拡張
- **TransformCalculation.cs**: Transform計算ユーティリティ

#### NetWork/（ネットワークシステム）
- **GameLauncher.cs**: ゲーム起動制御
- **PhotonConnectionTest.cs**: 接続テスト
- **PoolObjectProvider.cs**: オブジェクトプール管理

**Connection/** & **Pooling/** & **Synchronization/**
- ネットワーク関連の詳細実装

#### SubEditor/（エディター支援）
- **RequiredAttribute.cs**: 必須フィールド属性

#### UI/（ユーザーインターフェース）

**Base/**
- **PhaseEndButtonBase.cs**: フェーズ終了ボタン基底
  - VitalRouterコマンド発行
  - 依存性注入対応

- **PreparationEndButton.cs**: 準備フェーズ終了ボタン
- **ShipShieldButton.cs**: シールドボタン
- **UpgradePhaseEndButton.cs**: アップグレードフェーズ終了ボタン

### Editor/（エディター拡張）
- **Attribute.cs**: カスタム属性
- **AutoSave.cs**: 自動保存機能
- **EmptyFieldWarningEditor.cs**: 空フィールド警告
- **SubClassGenerator.cs**: サブクラス生成ツール

### Prefab/（プレハブ）
```
Prefab/
├── Character/
│   └── Enemy/          # 敵キャラクタープレハブ
└── Object/
    └── Bullet/         # 弾丸プレハブ
```

## 技術アーキテクチャ

### ネットワーク同期（Photon Fusion2）
- **PeerMode**: Shared Mode使用
- **プレイヤー数**: 最大4人
- **同期方式**: 
  - `[Networked]`プロパティによる状態同期
  - RPCによるイベント通信
  - ラグ補償機能活用

### 依存性注入（VContainer）
- ProjectInstallerによる一元管理
- VitalRouterとの統合
- コンポーネントベース登録

### コマンドシステム（VitalRouter）
- GameStateChangeCommandによる状態変更
- ルーティングベース通信
- リアクティブなイベント処理

### リアクティブプログラミング（R3）
- ReactivePropertyによる状態管理
- ゲーム状態の購読・通知システム

## 実装状況

### 完了済み機能
- ✅ ネットワーク基盤（最大4人同期）
- ✅ プレイヤーアバター同期
- ✅ 入力同期システム
- ✅ DIシステム（VContainer + VitalRouter統合）
- ✅ ゲームフロー管理（GameFlowHandler + WaveHandler）
- ✅ 弾丸システム（ラグ補償対応）
- ✅ 敵AIシステム（BaseEnemy + ステートマシン）
- ✅ 敵攻撃システム（ターゲット検索・自動照準）
- ✅ ウェーブスポーンシステム

### 実装中機能
- 🔄 戦闘システム（ダメージ処理実装中）
- 🔄 HP/耐久値システム

### 設計完了・実装待ち
- 📋 シールドシステム詳細実装
- 📋 インタラクションシステム拡張

## ファイル命名規則

### スクリプト
- クラス名 = ファイル名（PascalCase）
- インターフェース: `I`プレフィックス
- 基底クラス: `Base`プレフィックス
- RPC: `RPC_`プレフィックス

### アセット
- ScriptableObject: 機能名 + `Configuration`
- プレハブ: 機能・タイプを明確に

## 開発ガイドライン

### ネットワーク同期
1. 継続的状態は`[Networked]`プロパティ
2. 一時的イベントはRPC
3. 権限確認（`HasStateAuthority`）必須
4. ローカル反応 + リモート確認のハイブリッド方式

### 依存性管理
1. VContainer経由での注入
2. インターフェースベース設計
3. ProjectInstallerでの一元管理

### ゲーム状態管理
1. VitalRouterコマンドパターン使用
2. R3によるリアクティブ設計
3. ネットワーク同期された状態管理

## 参考ドキュメント

プロジェクト内の詳細仕様は以下のドキュメントを参照：

- `Docs/敵システム仕様書.md`: 敵システムの詳細仕様
- `Docs/Fusion2_同期通信方式まとめ.md`: ネットワーク同期方式
- `Docs/Pirate_Adventure_Tech_Design.md`: Photon Fusion技術設計
- `Docs/FusionObjectPooling.cs解説.md`: オブジェクトプール解説
- `Docs/Runnerとは.md`: NetworkRunner詳細解説
